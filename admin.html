<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin Orders</title>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>
  <div class="bg"></div>
  <div class="overlay"></div>

  <main class="wrap">
    <section class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h1 style="margin:0;">Admin – Orders</h1>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn primary" id="loginBtn" type="button">Login as Admin</button>
          <button class="btn ghost" id="logoutBtn" type="button">Logout</button>
          <a class="btn ghost" href="./index.html">Back to Site</a>
        </div>
      </div>

      <!-- Login box (shows only when not logged in) -->
      <div id="loginBox" style="margin-top:12px; display:none; border:1px solid var(--line); border-radius:16px; padding:12px; background:rgba(0,0,0,.25);">
        <div style="font-weight:700; margin-bottom:6px;">Admin Access</div>
        <div style="opacity:.85; margin-bottom:10px;">
          Login with Discord to manage orders (requires the admin role).
        </div>
        <button class="btn primary" id="loginBtn2" type="button">Login with Discord</button>
      </div>

      <div class="controls" style="margin-top:12px;">
        <div class="field grow">
          <label>Filter</label>
          <input id="q" placeholder="Search orderId / player / server / status" />
        </div>

        <button class="btn" id="refreshBtn" type="button">Refresh</button>
      </div>

      <div class="pill" id="adminMsg">Waiting…</div>

      <div id="orders" style="margin-top:12px; display:flex; flex-direction:column; gap:12px;"></div>
    </section>
  </main>

  <script>
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxzktqrK7hZiiMJh4yjn3aStx0V0-x3LJkQne9LP5Bjtch1XpEFb4E5bKEDIcvU3xA8/exec";

    // Must match what you configured in Discord + Apps Script
    const DISCORD_CLIENT_ID = "1455019955048288268";
    const DISCORD_REDIRECT_URI = "https://bigdogtv.github.io/TheFactoryBM/admin.html";
    const DISCORD_SCOPES = "identify guilds.members.read";

    const $ = (id) => document.getElementById(id);

    function setMsg(t){ $("adminMsg").textContent = t; }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    function getSession(){ return sessionStorage.getItem("ADMIN_SESSION") || ""; }
    function setSession(s){ sessionStorage.setItem("ADMIN_SESSION", s || ""); }

    function showLoginBox(show){
      const el = $("loginBox");
      if (el) el.style.display = show ? "block" : "none";
    }

    function discordAuthUrl(){
      const params = new URLSearchParams({
        client_id: DISCORD_CLIENT_ID,
        redirect_uri: DISCORD_REDIRECT_URI,
        response_type: "code",
        scope: DISCORD_SCOPES
      });
      return `https://discord.com/oauth2/authorize?${params.toString()}`;
    }

    // ===== Staff list for assignment dropdown =====
const STAFF_OPTIONS = [
  "",            // blank = unassigned
  "BigDog",
  "",
  "",
  ""
];


    // JSONP loader
    function jsonp(url, cbName){
      return new Promise((resolve, reject) => {
        const id = "jsonp_" + Date.now();
        window[cbName] = (data) => { resolve(data); cleanup(); };
        function cleanup(){
          document.getElementById(id)?.remove();
          try { delete window[cbName]; } catch {}
        }
        const s = document.createElement("script");
        s.id = id;
        s.src = url + "&t=" + Date.now();
        s.onerror = () => { cleanup(); reject(new Error("JSONP load failed")); };
        document.body.appendChild(s);
      });
    }

    async function exchangeCodeForSession(code){
      const cb = "__oauthCB_" + Date.now();
      // IMPORTANT: your Code.gs lowercases mode, so use lowercase here
      const url = `${ENDPOINT_URL}?mode=oauthexchange&code=${encodeURIComponent(code)}&callback=${cb}`;
      const data = await jsonp(url, cb);
      if(!data?.ok) throw new Error(data?.message || "OAuth failed");
      if(!data.session) throw new Error("OAuth exchange failed: missing session.");
      return data; // {ok, session, user}
    }

    function statusButtons(orderId, current){
      const statuses = ["new","accepted","preparing","ready","completed","cancelled"];
      return statuses.map(st => `
        <button class="btn ${st===current ? "primary" : "ghost"}"
          data-oid="${orderId}" data-status="${st}">
          ${st}
        </button>
      `).join("");
    }

    async function fetchOrders(){
      const session = getSession();
      if(!session){
        showLoginBox(true);
        setMsg("Login as Admin to access orders.");
        $("orders").innerHTML = "";
        return;
      }

      showLoginBox(false);
      setMsg("Loading orders…");

      const cb = "__ordersCB_" + Date.now();
      const url = `${ENDPOINT_URL}?mode=orders&session=${encodeURIComponent(session)}&callback=${cb}`;

      let data;
      try{
        data = await jsonp(url, cb);
      }catch(e){
        showLoginBox(true);
        setMsg("Failed to load orders. Session expired? Click Login as Admin.");
        return;
      }

      if(!data.ok){
        showLoginBox(true);
        setMsg(data.message || "Unauthorized");
        return;
      }

      const q = ($("q").value || "").toLowerCase().trim();
      const list = (data.orders || []).filter(o => {
      const st = String(o.status || "").toLowerCase();

      // Hide completed/cancelled by default
      if (!q && (st === "completed" || st === "cancelled")) return false;

      if(!q) return true;

      const blob = `${o.orderId} ${o.playerName} ${o.server} ${o.status}`.toLowerCase();
      return blob.includes(q);
});


      renderOrders(list);
      setMsg(`Loaded ${list.length} orders`);
    }

    function renderOrders(list){
      const root = $("orders");
      root.innerHTML = "";

      for(const o of list){
        const div = document.createElement("div");
        div.style.border = "1px solid var(--line)";
        div.style.borderRadius = "16px";
        div.style.padding = "12px";
        div.style.background = "rgba(0,0,0,.25)";

        div.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
            <div>
              <div style="font-weight:700;">${escapeHtml(o.orderId)} <span style="opacity:.7;">(${escapeHtml(o.status)})</span></div>
              <div style="opacity:.85;">${escapeHtml(o.playerName)} • ${escapeHtml(o.server)} • ${escapeHtml(o.priceMode)}</div>
              <div style="opacity:.7; font-size:12px;">${escapeHtml(String(o.timestamp))}</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <a class="btn ghost" href="./receipt.html?orderId=${encodeURIComponent(o.orderId)}" target="_blank">Receipt</a>
            </div>
          </div>

          <pre style="white-space:pre-wrap; margin:10px 0 0;">${escapeHtml(o.items_text || "")}</pre>

          <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px;">
            <div class="field">
              <label>Pickup Location</label>
              <input data-ploc="${o.orderId}" value="${escapeHtml(o.pickupLocation || "")}" />
            </div>
            <div class="field">
              <label>Pickup Window</label>
              <input data-pwin="${o.orderId}" value="${escapeHtml(o.pickupWindow || "")}" />
            </div>
            <div class="field">
              <label>Notes</label>
              <input data-notes="${o.orderId}" value="${escapeHtml(o.notes || "")}" />
            </div>
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
            ${statusButtons(o.orderId, o.status)}
          </div>
        `;

        root.appendChild(div);
      }

      // bind status buttons
      root.querySelectorAll("button[data-oid]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const session = getSession();
          const orderId = btn.getAttribute("data-oid");
          const status = btn.getAttribute("data-status");

          const ploc  = root.querySelector(`input[data-ploc="${CSS.escape(orderId)}"]`)?.value || "";
          const pwin  = root.querySelector(`input[data-pwin="${CSS.escape(orderId)}"]`)?.value || "";
          const notes = root.querySelector(`input[data-notes="${CSS.escape(orderId)}"]`)?.value || "";

          setMsg(`Updating ${orderId} → ${status}…`);

          const cb = "__updCB_" + Date.now();
          const url = `${ENDPOINT_URL}?mode=adminUpdate&session=${encodeURIComponent(session)}`
            + `&orderId=${encodeURIComponent(orderId)}`
            + `&status=${encodeURIComponent(status)}`
            + `&pickupLocation=${encodeURIComponent(ploc)}`
            + `&pickupWindow=${encodeURIComponent(pwin)}`
            + `&notes=${encodeURIComponent(notes)}`
            + `&callback=${cb}`;

          try{
            const data = await jsonp(url, cb);
            if(!data.ok) throw new Error(data.message || "Update failed");
            await fetchOrders();
          }catch(e){
            setMsg(String(e.message || e));
          }
        });
      });
    }

    function startLogin(){
      window.location.href = discordAuthUrl();
    }

    window.addEventListener("DOMContentLoaded", async () => {
      $("loginBtn").addEventListener("click", startLogin);
      $("loginBtn2").addEventListener("click", startLogin);

      $("logoutBtn").addEventListener("click", () => {
        setSession("");
        $("orders").innerHTML = "";
        showLoginBox(true);
        setMsg("Logged out.");
        history.replaceState({}, "", "./admin.html");
      });

      $("refreshBtn").addEventListener("click", fetchOrders);
      $("q").addEventListener("input", fetchOrders);

      // If Discord redirected back with ?code=
      const code = new URLSearchParams(location.search).get("code");
      if(code){
        setMsg("Finishing Discord login…");
        try{
          const data = await exchangeCodeForSession(code);
          setSession(data.session);

          const uname = data?.user?.username || "admin";
          setMsg(`Logged in as ${uname}. Loading orders…`);

          // clean URL (remove ?code=)
          history.replaceState({}, "", "./admin.html");

          await fetchOrders();
        }catch(err){
          const msg = String(err.message || err);
          if (msg.toLowerCase().includes("missing required role")) {
            setMsg("You are logged into Discord, but you do NOT have the required admin role on this server.");
          } else {
            setMsg(msg);
          }
          showLoginBox(true);
        }
        return;
      }

      // Normal load
      if(getSession()){
        showLoginBox(false);
        setMsg("Session found. Loading orders…");
        await fetchOrders();
      } else {
        showLoginBox(true);
        setMsg("Click Login as Admin to continue.");
      }
    });
  </script>
</body>
</html>