<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Receipt</title>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>
  <div class="bg"></div>
  <div class="overlay"></div>

  <main class="wrap">
    <section class="panel">
      <h1 style="margin:0 0 10px;">Order Receipt</h1>

      <div class="controls">
        <div class="field grow">
          <label>Order ID</label>
          <input id="orderIdInput" placeholder="DZ-XXXXXXXX" />
        </div>
        <button class="btn primary" id="lookupBtn" type="button">Lookup</button>
        <a class="btn ghost" href="./index.html">Back</a>
      </div>

      <div class="pill" id="receiptStatus">Waiting…</div>

      <pre id="receiptBox" style="white-space:pre-wrap; margin-top:12px; padding:12px; border:1px solid var(--line); border-radius:14px; background:rgba(0,0,0,.25);"></pre>
    </section>
  </main>

  <script>
  const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxzktqrK7hZiiMJh4yjn3aStx0V0-x3LJkQne9LP5Bjtch1XpEFb4E5bKEDIcvU3xA8/exec";
  const $ = (id) => document.getElementById(id);

  function lookup(orderId){
    $("receiptStatus").textContent = "Loading…";
    $("receiptBox").textContent = "";

    document.getElementById("jsonp")?.remove();

    window.__onOrder = (data) => {
      if(!data || !data.ok){
        $("receiptStatus").textContent = "Not found";
        $("receiptBox").textContent = data?.message || "Order not found";
        return;
      }
      const o = data.order;
      $("receiptStatus").textContent = `Status: ${o.status}`;
      $("receiptBox").textContent =
        `Order ID: ${o.orderId}\n` +
        `Time: ${o.timestamp}\n` +
        `Player: ${o.playerName}\n` +
        `Server: ${o.server}\n` +
        `Discord: ${o.discord}\n` +
        `Mode: ${o.priceMode}\n` +
        `Total: ${o.total}\n\n` +
        (o.items_text || "");
    };

    const url = `${ENDPOINT_URL}?mode=order&orderId=${encodeURIComponent(orderId)}&callback=__onOrder&t=${Date.now()}`;

    const s = document.createElement("script");
    s.id = "jsonp";
    s.src = url;
    s.async = true;

    const timer = setTimeout(() => {
      $("receiptStatus").textContent = "Lookup failed";
      $("receiptBox").textContent =
        "Timeout waiting for response.\n\nTried:\n" + url +
        "\n\nOpen that link in a new tab. You should see: __onOrder({...});";
    }, 6000);

    s.onload = () => clearTimeout(timer);
    s.onerror = () => {
      clearTimeout(timer);
      $("receiptStatus").textContent = "Lookup failed";
      $("receiptBox").textContent =
        "JSONP script failed to load.\n\nTried:\n" + url +
        "\n\nOpen that link in a new tab. If it works there, hard refresh this page (Ctrl+F5).";
    };

    document.body.appendChild(s);
  }

  window.addEventListener("DOMContentLoaded", () => {
    const btn = $("lookupBtn");
    btn.addEventListener("click", () => {
      const id = ($("orderIdInput").value || "").trim();
      if(id) lookup(id);
    });

    const urlId = (new URLSearchParams(location.search)).get("orderId") || "";
    if(urlId){
      $("orderIdInput").value = urlId;
      lookup(urlId);
    } else {
      $("receiptStatus").textContent = "Enter an Order ID and click Lookup";
    }
  });
</script>

</body>
</html>

