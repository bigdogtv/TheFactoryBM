<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Receipt</title>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>
  <div class="bg"></div>
  <div class="overlay"></div>

  <main class="wrap">
    <section class="panel">
      <h1 style="margin:0 0 10px;">Order Receipt</h1>

      <div class="controls">
        <div class="field grow">
          <label>Order ID</label>
          <input id="orderIdInput" placeholder="DZ-XXXXXXXX" />
        </div>
        <button class="btn primary" id="lookupBtn" type="button">Lookup</button>
        <a class="btn ghost" href="./index.html">Back</a>
      </div>

      <div class="pill" id="receiptStatus">Waiting…</div>

      <pre id="receiptBox" style="white-space:pre-wrap; margin-top:12px; padding:12px; border:1px solid var(--line); border-radius:14px; background:rgba(0,0,0,.25);"></pre>
    </section>
  </main>

  <script>
    const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxzktqrK7hZiiMJh4yjn3aStx0V0-x3LJkQne9LP5Bjtch1XpEFb4E5bKEDIcvU3xA8/exec";
    const $ = (id) => document.getElementById(id);

  function qs(name){
    const p = new URLSearchParams(location.search);
    return p.get(name) || "";
  }

  // JSONP callback
  window.__onOrder = (data) => {
    if(!data || !data.ok){
      $("receiptStatus").textContent = "Not found";
      $("receiptBox").textContent = data?.message || "Order not found";
      return;
    }
    const o = data.order;
    $("receiptStatus").textContent = `Status: ${o.status}`;
    $("receiptBox").textContent =
      `Order ID: ${o.orderId}\n` +
      `Time: ${o.timestamp}\n` +
      `Player: ${o.playerName}\n` +
      `Server: ${o.server}\n` +
      `Discord: ${o.discord}\n` +
      `Mode: ${o.priceMode}\n` +
      `Total: ${o.total}\n\n` +
      (o.items_text || "");
  };

  function lookup(orderId){
  $("receiptStatus").textContent = "Loading…";
  $("receiptBox").textContent = "";

  // remove any prior jsonp script
  const old = document.getElementById("jsonp");
  if (old) old.remove();

  // define callback BEFORE inserting script
  window.__onOrder = (data) => {
    if(!data || !data.ok){
      $("receiptStatus").textContent = "Not found";
      $("receiptBox").textContent = data?.message || "Order not found";
      return;
    }
    const o = data.order;
    $("receiptStatus").textContent = `Status: ${o.status}`;
    $("receiptBox").textContent =
      `Order ID: ${o.orderId}\n` +
      `Time: ${o.timestamp}\n` +
      `Player: ${o.playerName}\n` +
      `Server: ${o.server}\n` +
      `Discord: ${o.discord}\n` +
      `Mode: ${o.priceMode}\n` +
      `Total: ${o.total}\n\n` +
      (o.items_text || "");
  };

  const s = document.createElement("script");
  s.id = "jsonp";
  s.src = `${ENDPOINT_URL}?mode=order&orderId=${encodeURIComponent(orderId)}&callback=__onOrder&t=${Date.now()}`;

  // ⬇⬇⬇ THIS IS WHERE YOUR CODE GOES ⬇⬇⬇
  s.onerror = () => {
    $("receiptStatus").textContent = "Lookup failed";
    $("receiptBox").textContent =
      "JSONP load failed.\n\nTried:\n" + s.src +
      "\n\nOpen that link in a new tab. If you see a Google page (not __onOrder(...)), it’s an access/deploy issue.";
  };

  document.body.appendChild(s);
}

</script>
</body>
</html>

